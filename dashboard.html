<!DOCTYPE html>
<html lang="en" translate="no" class="notranslate">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="google" content="notranslate">
  <title>Ghost's Dashboard</title>
  <link rel="stylesheet" href="dashboard.css">
</head>
<body>

<canvas id="bgCanvas"></canvas>
<div class="container">

  <header>
    <div class="logo-hex"></div>
    <div class="header-copy">
      <h1>GHOST'S <em>DASHBOARD</em></h1>
      <small>Roblox Live Stats Tracker</small>
    </div>
    <div class="live-pill">
      <span class="dot-blink"></span>
      Live
    </div>
  </header>

  <div class="tab-row">
    <div class="tabs" id="tabs"></div>
    <button class="icon-btn" id="searchBtn" title="Search game by ID" aria-label="Search game">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="22" y2="22"/>
      </svg>
    </button>
    <button class="icon-btn" id="settingsBtn" title="Settings" aria-label="Settings">
      <svg width="17" height="17" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"/>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
      </svg>
    </button>
  </div>

  <div id="panels"></div>

  <!-- ‚îÄ‚îÄ Popular Games ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
  <section class="popular-section">
    <div class="popular-header">
      <div class="popular-title">
        <span class="flame">üî•</span>
        <h2>Top 25 Most Popular Right Now</h2>
      </div>
      <div style="display:flex;align-items:center;gap:10px;">
        <span class="popular-meta" id="popularMeta">‚Äî</span>
        <button class="popular-refresh-btn" id="popularRefreshBtn">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/>
            <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/>
          </svg>
          Refresh
        </button>
      </div>
    </div>

    <div class="popular-table-wrap">
      <div class="popular-cols">
        <span class="popular-col-label">#</span>
        <span class="popular-col-label"></span>
        <span class="popular-col-label">Game</span>
        <span class="popular-col-label right">Visits</span>
        <span class="popular-col-label right">Playing</span>
        <span class="popular-col-label right">Likes</span>
        <span class="popular-col-label right">Updated</span>
      </div>
      <div id="popularList">
        <!-- rows injected by JS -->
      </div>
    </div>
  </section>

  <div class="cors-note" id="corsNote">
    <strong>‚ö† CORS Restriction Detected</strong><br>
    Browsers block direct calls to the Roblox API when opening HTML files locally.
    Use one of these options:<br><br>
    Chrome: <code>chrome --disable-web-security --user-data-dir=/tmp/rbx-test</code><br>
    Firefox: install the <strong>CORS Everywhere</strong> extension.<br>
    Or: <code>npx serve .</code>
  </div>

</div>

<!-- ‚îÄ‚îÄ‚îÄ Search Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="overlay" id="searchOverlay">
  <div class="modal">
    <div class="search-modal-header">
      <div class="search-modal-title">Search by Place ID</div>
      <div class="search-input-wrap">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round">
          <circle cx="11" cy="11" r="7"/><line x1="16.5" y1="16.5" x2="22" y2="22"/>
        </svg>
        <input class="search-input" id="searchInput" type="text" inputmode="numeric"
          placeholder="Enter Place ID e.g. 2753915549" autocomplete="off" spellcheck="false">
        <button class="search-go-btn" id="searchGoBtn">Search</button>
      </div>
    </div>
    <div class="search-result hidden" id="searchResult"></div>
    <div class="modal-close-hint">
      <span>Press <kbd>Esc</kbd> to close</span>
      <span>Search is read-only</span>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ Settings Modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
<div class="overlay" id="settingsOverlay">
  <div class="modal">
    <div class="settings-header">
      <div class="settings-title">
        Settings
        <span>Preferences are saved automatically</span>
      </div>
      <button class="settings-close-x" id="settingsCloseX" aria-label="Close settings">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div>
        <div class="settings-section-label">Accent Colour</div>
        <div class="color-row">
          <div class="color-swatch-grid" id="colorSwatches"></div>
          <div class="color-custom-wrap">
            <span class="color-custom-label">Custom</span>
            <input class="color-picker-input" type="color" id="colorPicker">
            <input class="color-hex-input" type="text" id="colorHex" maxlength="7" spellcheck="false" placeholder="#630e20">
          </div>
        </div>
      </div>
      <div>
        <div class="settings-section-label">Pinned Games</div>
        <div class="pinned-games-list" id="pinnedGamesList"></div>
        <div style="margin-top:10px;font-family:var(--mono);font-size:10px;color:var(--muted);line-height:1.6;">
          Enter Place IDs. Changes apply after saving.
        </div>
      </div>
    </div>
    <div class="settings-footer">
      <span class="settings-save-msg" id="settingsSaveMsg">‚úì Saved</span>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="settings-btn settings-btn-secondary" id="settingsResetBtn">Reset defaults</button>
        <button class="settings-btn settings-btn-primary"   id="settingsSaveBtn">Save &amp; Apply</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Constants & defaults
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
// ‚îÄ‚îÄ YOUR CLOUDFLARE WORKER URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Deploy worker.js to https://workers.cloudflare.com (free)
// then replace the placeholder below with your worker URL.
const WORKER_URL = 'https://YOUR-WORKER-NAME.YOUR-SUBDOMAIN.workers.dev';
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const REFRESH       = 30_000;
const POPULAR_REFRESH = 5 * 60_000; // refresh live stats every 5 min
const LS_KEY        = 'ghost_dashboard_settings';
const PRESET_COLORS = ['#630e20','#c0192e','#1a6b2a','#0e4fa8','#7c3aed','#b45309','#0e7490','#be185d'];

// ‚îÄ‚îÄ‚îÄ Edit these fallback IDs if ids.json can't be loaded ‚îÄ‚îÄ‚îÄ
const FALLBACK_IDS = [
  { placeId: '140040331310207', label: 'Game 1' },
  { placeId: '2753915549',      label: 'Game 2' },
  { placeId: '15532962292',     label: 'Game 3' },
];

const DEFAULT_SETTINGS = {
  accentBase:  '#630e20',
  pinnedGames: FALLBACK_IDS.map(g => g.placeId),
};

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Settings
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function loadSettings() {
  try { const r = localStorage.getItem(LS_KEY); if (r) return { ...DEFAULT_SETTINGS, ...JSON.parse(r) }; } catch {}
  return { ...DEFAULT_SETTINGS };
}
function saveSettings(s) { try { localStorage.setItem(LS_KEY, JSON.stringify(s)); } catch {} }

function hexToRgb(hex) {
  return [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
}
function lighten(hex, amt) {
  return '#' + hexToRgb(hex).map(x => Math.min(255,x+amt).toString(16).padStart(2,'0')).join('');
}
function applyAccent(hex) {
  if (!/^#[0-9a-fA-F]{6}$/.test(hex)) return;
  const light = lighten(hex, 60), bright = lighten(hex, 100);
  const [r,g,b] = hexToRgb(hex), [rl,gl,bl] = hexToRgb(light);
  const root = document.documentElement;
  root.style.setProperty('--accent',        hex);
  root.style.setProperty('--accent-light',  light);
  root.style.setProperty('--accent-bright', bright);
  root.style.setProperty('--accent-dim',    `rgba(${r},${g},${b},0.2)`);
  root.style.setProperty('--accent-glow',   `rgba(${rl},${gl},${bl},0.4)`);
  root.style.setProperty('--pattern-accent',`rgba(${r},${g},${b},0.18)`);
  root.style.setProperty('--pattern-hatch', `rgba(${r},${g},${b},0.055)`);
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   State
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
let GAMES     = [];
let activeTab = 0;
const intervals   = [];
let settings      = loadSettings();
let popularTimer  = null;

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Helpers
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function fmt(n) {
  if (n == null) return '‚Äî';
  if (n >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1) + 'B';
  if (n >= 1_000_000)     return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 1_000)         return (n / 1_000).toFixed(1) + 'K';
  return n.toLocaleString();
}
function setEl(id, val) { const el = document.getElementById(id); if (el) el.textContent = val; }

async function tryFetch(url) {
  const headers = { 'Accept': 'application/json', 'Accept-Language': 'en-US,en;q=0.9' };
  try {
    const r = await fetch(`${WORKER_URL}?url=${encodeURIComponent(url)}`, { headers });
    if (r.ok) return r.json();
  } catch {}
  return null;
}
async function getUniverseId(placeId) {
  const base = `https://apis.roblox.com/universes/v1/places/${placeId}/universe`;
  const j = await tryFetch(base);
  return j?.universeId ?? null;
}

/* chunk array into groups of n */
function chunk(arr, n) {
  const out = [];
  for (let i = 0; i < arr.length; i += n) out.push(arr.slice(i, i+n));
  return out;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Pinned dashboard
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function buildTabs() {
  const tabsEl = document.getElementById('tabs');
  tabsEl.innerHTML = '';
  GAMES.forEach((g, i) => {
    const btn = document.createElement('button');
    btn.className = 'tab-btn' + (i === 0 ? ' active' : '');
    btn.setAttribute('translate', 'no');
    btn.classList.add('notranslate');
    btn.textContent = g.label || `Game ${i + 1}`;
    btn.addEventListener('click', () => switchTab(i));
    tabsEl.appendChild(btn);
  });
}
function switchTab(i) {
  activeTab = i;
  document.querySelectorAll('.tab-btn')   .forEach((b, j) => b.classList.toggle('active', j === i));
  document.querySelectorAll('.game-panel').forEach((p, j) => p.classList.toggle('active', j === i));
}

function buildPanel(game, i) {
  const div = document.createElement('div');
  div.className = 'game-panel' + (i === 0 ? ' active' : '');
  div.id = `panel-${i}`;
  div.innerHTML = `
    <div class="game-card">
      <div class="card-header">
        <div class="game-icon-wrap" id="icon-${i}">
          <div class="game-icon-placeholder">
            <svg width="34" height="34" viewBox="0 0 24 24" fill="white"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>
          </div>
        </div>
        <div class="game-title-area">
          <div class="place-id-tag">Place ID ¬∑ ${game.placeId}</div>
          <div class="game-name notranslate" id="name-${i}" translate="no">Loading‚Ä¶</div>
          <div class="game-creator" id="creator-${i}"></div>
          <a class="play-btn" href="https://www.roblox.com/games/${game.placeId}" target="_blank" rel="noopener">
            <svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>
            Play on Roblox
          </a>
        </div>
      </div>
      <div class="stats-grid">
        <div class="stat-cell stat-visits">
          <div class="stat-label"><span class="stat-icon"></span>Total Visits</div>
          <div class="stat-value" id="visits-${i}">‚Äî</div>
          <div class="stat-sub" id="visits-exact-${i}">‚Äî</div>
        </div>
        <div class="stat-cell stat-active">
          <div class="stat-label"><span class="stat-icon"></span>Active Now</div>
          <div class="stat-value" id="active-${i}">‚Äî</div>
          <div class="stat-sub">players online</div>
        </div>
        <div class="stat-cell stat-ratio">
          <div class="stat-label"><span class="stat-icon"></span>Like Ratio</div>
          <div class="stat-value" id="ratio-pct-${i}">‚Äî</div>
          <div class="vote-row">
            <span class="vote-likes" id="vote-likes-${i}">‚Äî</span>
            <span class="vote-sep">‚Äì</span>
            <span class="vote-dislikes" id="vote-dislikes-${i}">‚Äî</span>
          </div>
          <div class="ratio-track"><div class="ratio-fill" id="ratio-fill-${i}"></div></div>
        </div>
      </div>
      <div class="update-bar">
        <span class="dot-blink" style="color:var(--green)"></span>
        <span>Refreshes every 30s</span>
        <span class="update-time" id="updated-${i}">‚Äî</span>
      </div>
    </div>`;
  return div;
}

async function fetchGame(game, i) {
  if (!game.universeId) {
    const uid = await getUniverseId(game.placeId);
    if (!uid) { setEl(`name-${i}`, 'Could not resolve game'); document.getElementById('corsNote').classList.add('show'); return; }
    game.universeId = uid;
  }
  const infoBase  = `https://games.roblox.com/v1/games?universeIds=${game.universeId}&lang=en`;
  const votesBase = `https://games.roblox.com/v1/games/${game.universeId}/votes`;
  const [infoJson, votesJson] = await Promise.all([
    tryFetch(infoBase),
    tryFetch(votesBase)
  ]);
  const d = infoJson?.data?.[0];
  if (!d) { setEl(`name-${i}`, 'Could not load'); document.getElementById('corsNote').classList.add('show'); return; }

  const name     = d.name || 'Unknown Game';
  const creator  = d.creator?.name ? `by ${d.creator.name}` : '';
  const visits   = d.visits ?? null, playing = d.playing ?? null;
  const likes    = votesJson?.upVotes ?? null, dislikes = votesJson?.downVotes ?? null;
  const total    = (likes??0)+(dislikes??0);
  const pct      = total > 0 ? Math.round(((likes??0)/total)*100) : null;

  setEl(`name-${i}`, name); setEl(`creator-${i}`, creator);
  setEl(`visits-${i}`, fmt(visits)); setEl(`visits-exact-${i}`, visits!=null ? visits.toLocaleString()+' total' : '‚Äî');
  setEl(`active-${i}`, fmt(playing));
  setEl(`ratio-pct-${i}`, pct!=null ? pct+'%' : '‚Äî');
  setEl(`vote-likes-${i}`, likes!=null ? fmt(likes)+' üëç' : '‚Äî');
  setEl(`vote-dislikes-${i}`, dislikes!=null ? fmt(dislikes)+' üëé' : '‚Äî');
  setEl(`updated-${i}`, 'Updated '+new Date().toLocaleTimeString());
  const fill = document.getElementById(`ratio-fill-${i}`);
  if (fill) fill.style.width = (pct??0)+'%';
  const btn = document.querySelectorAll('.tab-btn')[i];
  if (btn) { btn.textContent = name.length > 20 ? name.slice(0,18)+'‚Ä¶' : name; btn.setAttribute('translate','no'); }
  fetchIcon(game, i);
}

async function fetchIcon(game, i) {
  const base = `https://thumbnails.roblox.com/v1/games/icons?universeIds=${game.universeId}&returnPolicy=PlaceHolder&size=150x150&format=Png&isCircular=false`;
  const j = await tryFetch(base);
  const url = j?.data?.[0]?.imageUrl;
  if (!url) return;
  const wrap = document.getElementById(`icon-${i}`);
  if (!wrap) return;
  const img = document.createElement('img');
  img.className='game-icon'; img.src=url; img.alt='Game icon';
  img.onerror = () => { const ph=document.createElement('div'); ph.className='game-icon-placeholder'; ph.innerHTML=`<svg width="34" height="34" viewBox="0 0 24 24" fill="white" style="opacity:.2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg>`; wrap.replaceWith(ph); };
  wrap.innerHTML=''; wrap.appendChild(img);
}

function buildDashboard(placeIds) {
  intervals.forEach(clearInterval); intervals.length = 0;
  GAMES = placeIds.filter(Boolean).slice(0,3).map((id,i) => ({ placeId: String(id).trim(), label: `Game ${i+1}` }));
  buildTabs(); switchTab(0);
  const panelsEl = document.getElementById('panels');
  panelsEl.innerHTML = '';
  GAMES.forEach((g,i) => {
    panelsEl.appendChild(buildPanel(g,i));
    fetchGame(g,i);
    intervals.push(setInterval(() => fetchGame(g,i), REFRESH));
  });
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Popular Games  ‚îÄ‚îÄ Rolimons + Roblox API
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const TOP_N = 25;
const ROLIMONS_URL = 'https://api.rolimons.com/games/v1/gamelist';

function showPopularSkeletons() {
  const list = document.getElementById('popularList');
  list.innerHTML = Array.from({length: TOP_N}, () => `
    <div class="pop-skeleton">
      <div class="skel" style="width:18px;margin:auto;"></div>
      <div class="skel-icon"></div>
      <div style="padding:0 12px"><div class="skel" style="width:70%;margin-bottom:6px;"></div><div class="skel" style="width:40%;height:10px;"></div></div>
      <div class="skel" style="width:60px;margin-left:auto;"></div>
      <div class="skel" style="width:50px;margin-left:auto;"></div>
      <div class="skel" style="width:55px;margin-left:auto;"></div>
      <div class="skel" style="width:40px;margin-left:auto;"></div>
    </div>`).join('');
}

function buildPopularRow(rank, placeId, info, votes, iconUrl) {
  const name     = info?.name    || 'Unknown';
  const creator  = info?.creator?.name ? `by ${info.creator.name}` : '';
  const visits   = info?.visits  ?? null;
  const playing  = info?.playing ?? null;
  const updated  = info?.updated
    ? new Date(info.updated).toLocaleDateString(undefined, {month:'short', day:'numeric', year:'numeric'})
    : '‚Äî';
  const likes    = votes?.upVotes   ?? null;
  const dislikes = votes?.downVotes ?? null;
  const total    = (likes ?? 0) + (dislikes ?? 0);
  const pct      = total > 0 ? Math.round(((likes ?? 0) / total) * 100) : null;

  const iconEl = iconUrl
    ? `<img class="pop-icon" src="${iconUrl}" alt="" loading="lazy" onerror="this.replaceWith(Object.assign(document.createElement('div'),{className:'pop-icon-ph',innerHTML:'<svg width=20 height=20 viewBox=\\'0 0 24 24\\' fill=\\'white\\' style=\\'opacity:.15\\'><path d=\\'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z\\'/></svg>'}));">`
    : `<div class="pop-icon-ph"><svg width="20" height="20" viewBox="0 0 24 24" fill="white" style="opacity:.15"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg></div>`;

  const row = document.createElement('a');
  row.className = 'popular-row';
  row.href      = `https://www.roblox.com/games/${placeId}`;
  row.target    = '_blank';
  row.rel       = 'noopener';
  row.innerHTML = `
    <span class="pop-rank${rank <= 3 ? ' top3' : ''}">${rank}</span>
    ${iconEl}
    <div class="pop-info">
      <div class="pop-name notranslate" translate="no">${name}</div>
      <div class="pop-creator">${creator || `Place ID ${placeId}`}</div>
    </div>
    <div class="pop-stat pop-visits">
      <div class="pop-stat-val">${fmt(visits)}</div>
      <div class="pop-stat-label">total visits</div>
    </div>
    <div class="pop-stat pop-active">
      <div class="pop-stat-val">${fmt(playing)}</div>
      <div class="pop-stat-label">playing now</div>
    </div>
    <div class="pop-stat pop-ratio">
      <div class="pop-stat-val">${pct != null ? pct + '%' : '‚Äî'}</div>
      <div class="pop-stat-label">${likes != null ? fmt(likes)+'üëç '+fmt(dislikes)+'üëé' : 'no votes'}</div>
      <div class="pop-ratio-bar"><div class="pop-ratio-fill" style="width:${pct ?? 0}%"></div></div>
    </div>
    <div class="pop-updated">${updated}</div>`;
  return row;
}

async function loadPopularGames() {
  const btn  = document.getElementById('popularRefreshBtn');
  const list = document.getElementById('popularList');
  btn.classList.add('spinning');
  setEl('popularMeta', 'Loading‚Ä¶');
  showPopularSkeletons();

  // 1. Fetch Rolimons via worker (no CORS issues since worker fetches server-side)
  const roliData = await tryFetch(ROLIMONS_URL);

  if (!roliData?.games) {
    list.innerHTML = `<div class="popular-error">‚ö† Could not load popular games list. Try refreshing.</div>`;
    setEl('popularMeta', 'Failed');
    btn.classList.remove('spinning');
    return;
  }

  // 2. Sort by active players, take top N ‚Äî gives us real current rankings
  const top = Object.entries(roliData.games)
    .map(([placeId, arr]) => ({ placeId, name: arr[0], activePlayers: arr[1] ?? 0, icon: arr[2] ?? null }))
    .sort((a, b) => b.activePlayers - a.activePlayers)
    .slice(0, TOP_N);

  // 3. Resolve universe IDs (needed for Roblox API calls) ‚Äî batched 5 at a time
  for (let i = 0; i < top.length; i += 5) {
    await Promise.all(top.slice(i, i + 5).map(async g => {
      const j = await tryFetch(`https://apis.roblox.com/universes/v1/places/${g.placeId}/universe`);
      g.universeId = j?.universeId ?? null;
    }));
  }

  const valid = top.filter(g => g.universeId);

  // 4. Batch-fetch game info + icons (10 per request)
  const infoMap = {}, iconMap = {}, votesMap = {};

  await Promise.all(chunk(valid, 10).map(async batch => {
    const uids = batch.map(g => g.universeId).join(',');
    const [infoJ, iconJ] = await Promise.all([
      tryFetch(`https://games.roblox.com/v1/games?universeIds=${uids}&lang=en`),
      tryFetch(`https://thumbnails.roblox.com/v1/games/icons?universeIds=${uids}&returnPolicy=PlaceHolder&size=150x150&format=Png&isCircular=false`),
    ]);
    (infoJ?.data ?? []).forEach(d => { infoMap[String(d.id)] = d; });
    (iconJ?.data ?? []).forEach(d => { iconMap[String(d.targetId)] = d.imageUrl; });
  }));

  // 5. Fetch votes individually
  await Promise.all(valid.map(async g => {
    const j = await tryFetch(`https://games.roblox.com/v1/games/${g.universeId}/votes`);
    if (j) votesMap[g.universeId] = j;
  }));

  // 6. Render ‚Äî already sorted by player count from Rolimons
  list.innerHTML = '';
  top.forEach((g, idx) => {
    const uid = g.universeId;
    // Use Rolimons icon as fallback since it's already in the data
    const iconUrl = (uid && iconMap[String(uid)]) || g.icon;
    list.appendChild(buildPopularRow(idx + 1, g.placeId, infoMap[String(uid)], votesMap[uid], iconUrl));
  });

  setEl('popularMeta', `Updated ${new Date().toLocaleTimeString()}`);
  btn.classList.remove('spinning');
}

document.getElementById('popularRefreshBtn').addEventListener('click', loadPopularGames);

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Search modal
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const searchBtn     = document.getElementById('searchBtn');
const searchOverlay = document.getElementById('searchOverlay');
const searchInput   = document.getElementById('searchInput');
const searchGoBtn   = document.getElementById('searchGoBtn');
const searchResult  = document.getElementById('searchResult');

function openSearch()  { searchOverlay.classList.add('open'); searchBtn.classList.add('active'); setTimeout(()=>searchInput.focus(),60); }
function closeSearch() { searchOverlay.classList.remove('open'); searchBtn.classList.remove('active'); searchInput.value=''; searchResult.classList.add('hidden'); searchResult.innerHTML=''; }

searchBtn.addEventListener('click', () => searchOverlay.classList.contains('open') ? closeSearch() : openSearch());
searchOverlay.addEventListener('click', e => { if (e.target===searchOverlay) closeSearch(); });
searchInput.addEventListener('keydown', e => { if (e.key==='Enter') runSearch(); });
searchGoBtn.addEventListener('click', runSearch);

async function runSearch() {
  const raw = searchInput.value.trim().replace(/\D/g,'');
  if (!raw) return;
  searchResult.classList.remove('hidden');
  searchResult.innerHTML = `<div class="search-loading"><div class="spinner"></div>Looking up Place ID ${raw}‚Ä¶</div>`;
  const uid = await getUniverseId(raw);
  if (!uid) { searchResult.innerHTML=`<div class="search-error">‚ö† Could not find a game with Place ID <strong>${raw}</strong>.</div>`; return; }
  const [infoJson,votesJson,iconJson] = await Promise.all([
    tryFetch(`https://games.roblox.com/v1/games?universeIds=${uid}&lang=en`),
    tryFetch(`https://games.roblox.com/v1/games/${uid}/votes`),
    tryFetch(`https://thumbnails.roblox.com/v1/games/icons?universeIds=${uid}&returnPolicy=PlaceHolder&size=150x150&format=Png&isCircular=false`)
  ]);
  const d = infoJson?.data?.[0];
  if (!d) { searchResult.innerHTML=`<div class="search-error">‚ö† Could not load data. Try again.</div>`; return; }
  const name=d.name||'Unknown Game', creator=d.creator?.name?`by ${d.creator.name}`:'';
  const visits=d.visits??null, playing=d.playing??null;
  const likes=votesJson?.upVotes??null, dislikes=votesJson?.downVotes??null;
  const total=(likes??0)+(dislikes??0), pct=total>0?Math.round(((likes??0)/total)*100):null;
  const iconUrl=iconJson?.data?.[0]?.imageUrl??null;
  const iconHTML=iconUrl?`<img class="search-result-icon" src="${iconUrl}" alt="icon">`:`<div class="search-result-icon-ph"><svg width="22" height="22" viewBox="0 0 24 24" fill="white" style="opacity:.2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/></svg></div>`;
  searchResult.innerHTML=`<div class="search-result-card"><div class="search-result-inner">${iconHTML}<div class="search-result-info"><div class="search-result-name notranslate" translate="no">${name}</div><div class="search-result-creator">${creator}</div><div class="search-result-stats"><span><span class="visits-val">${fmt(visits)}</span> visits</span><span><span class="active-val">${fmt(playing)}</span> online</span>${pct!=null?`<span style="color:var(--orange)">${pct}% liked</span>`:''} ${likes!=null?`<span style="color:var(--green)">${fmt(likes)} üëç</span>`:''} ${dislikes!=null?`<span style="color:var(--red)">${fmt(dislikes)} üëé</span>`:''}</div></div></div><div class="search-result-actions"><a class="search-open-btn" href="https://www.roblox.com/games/${raw}" target="_blank" rel="noopener"><svg width="11" height="11" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"/></svg>Play on Roblox</a></div></div>`;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Settings modal
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
const settingsBtn      = document.getElementById('settingsBtn');
const settingsOverlay  = document.getElementById('settingsOverlay');
const settingsCloseX   = document.getElementById('settingsCloseX');
const settingsSaveBtn  = document.getElementById('settingsSaveBtn');
const settingsResetBtn = document.getElementById('settingsResetBtn');
const settingsSaveMsg  = document.getElementById('settingsSaveMsg');
const colorPicker      = document.getElementById('colorPicker');
const colorHex         = document.getElementById('colorHex');

const swatchGrid = document.getElementById('colorSwatches');
PRESET_COLORS.forEach(hex => {
  const sw = document.createElement('button');
  sw.className='color-swatch'; sw.style.background=hex; sw.title=hex; sw.dataset.hex=hex;
  sw.addEventListener('click', ()=>setColorUI(hex));
  swatchGrid.appendChild(sw);
});

const pinnedList = document.getElementById('pinnedGamesList');
for (let i=0;i<3;i++) {
  const row=document.createElement('div'); row.className='pinned-game-row';
  row.innerHTML=`<span class="pinned-game-num">${i+1}</span><input class="pinned-game-input" id="pinnedInput-${i}" type="text" inputmode="numeric" placeholder="Place ID" autocomplete="off" spellcheck="false"><span class="pinned-game-status" id="pinnedStatus-${i}"></span>`;
  pinnedList.appendChild(row);
}

function setColorUI(hex) {
  if (!/^#[0-9a-fA-F]{6}$/.test(hex)) return;
  colorPicker.value=hex; colorHex.value=hex;
  document.querySelectorAll('.color-swatch').forEach(sw=>sw.classList.toggle('selected',sw.dataset.hex===hex));
  applyAccent(hex);
}

function openSettings() {
  setColorUI(settings.accentBase);
  settings.pinnedGames.forEach((id,i)=>{ const inp=document.getElementById(`pinnedInput-${i}`); if(inp) inp.value=id||''; });
  settingsOverlay.classList.add('open'); settingsBtn.classList.add('active');
}
function closeSettings() { settingsOverlay.classList.remove('open'); settingsBtn.classList.remove('active'); }

settingsBtn.addEventListener('click', ()=>settingsOverlay.classList.contains('open')?closeSettings():openSettings());
settingsCloseX.addEventListener('click', closeSettings);
settingsOverlay.addEventListener('click', e=>{ if(e.target===settingsOverlay) closeSettings(); });

colorPicker.addEventListener('input', ()=>setColorUI(colorPicker.value));
colorHex.addEventListener('input', ()=>{ const v=colorHex.value.trim(); if(/^#[0-9a-fA-F]{6}$/.test(v)) setColorUI(v); });
colorHex.addEventListener('keydown', e=>{ if(e.key==='Enter') settingsSaveBtn.click(); });

settingsSaveBtn.addEventListener('click', ()=>{
  const newColor=colorHex.value.trim();
  const newGames=[0,1,2].map(i=>document.getElementById(`pinnedInput-${i}`)?.value.trim().replace(/\D/g,'')||'');
  if (!/^#[0-9a-fA-F]{6}$/.test(newColor)) { colorHex.style.borderColor='var(--red)'; setTimeout(()=>colorHex.style.borderColor='',1200); return; }
  settings.accentBase=newColor; settings.pinnedGames=newGames;
  saveSettings(settings); applyAccent(newColor);
  settingsSaveMsg.classList.add('show'); setTimeout(()=>settingsSaveMsg.classList.remove('show'),2000);
  buildDashboard(newGames);
  setTimeout(closeSettings, 700);
});

settingsResetBtn.addEventListener('click', ()=>{
  settings={...DEFAULT_SETTINGS}; saveSettings(settings);
  setColorUI(settings.accentBase);
  settings.pinnedGames.forEach((id,i)=>{ const inp=document.getElementById(`pinnedInput-${i}`); if(inp) inp.value=id||''; });
  applyAccent(settings.accentBase); buildDashboard(settings.pinnedGames);
  settingsSaveMsg.classList.add('show'); setTimeout(()=>settingsSaveMsg.classList.remove('show'),2000);
  setTimeout(closeSettings,700);
});

document.addEventListener('keydown', e=>{
  if (e.key==='Escape') { closeSearch(); closeSettings(); }
  if (e.key==='k'&&(e.metaKey||e.ctrlKey)) { e.preventDefault(); openSearch(); }
});

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Boot
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
async function init() {
  applyAccent(settings.accentBase);
  let ids = settings.pinnedGames;

  // Always try ids.json first (works on GitHub Pages / any server)
  // Silently fall back to FALLBACK_IDS if unavailable (local file://, mobile, offline)
  try {
    const r = await fetch('ids.json');
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    const raw = await r.json();
    if (!Array.isArray(raw) || raw.length === 0) throw new Error('empty');
    const fromFile = raw.slice(0, 3).map(g =>
      typeof g === 'string' ? g : String(g.placeId)
    );
    // Only override saved prefs if user hasn't customised yet
    DEFAULT_SETTINGS.pinnedGames = [...fromFile];
    if (!ids || ids.every(x => !x)) {
      ids = fromFile;
      settings.pinnedGames = ids;
    }
  } catch {
    // ids.json unavailable ‚Äî use embedded FALLBACK_IDS silently
    if (!ids || ids.every(x => !x)) {
      ids = FALLBACK_IDS.map(g => g.placeId);
      settings.pinnedGames = ids;
    }
  }

  buildDashboard(ids);

  // Load popular games and set up auto-refresh
  loadPopularGames();
  popularTimer = setInterval(loadPopularGames, POPULAR_REFRESH);
}

init();
</script>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   Background canvas ‚Äî floating wireframe cubes
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
(function() {
  const canvas = document.getElementById('bgCanvas');
  const ctx    = canvas.getContext('2d');
  let W, H, cubes = [], accentRgb = [99, 14, 32];

  /* Read current accent colour from CSS vars */
  function readAccent() {
    const style = getComputedStyle(document.documentElement);
    const hex   = style.getPropertyValue('--accent').trim();
    const lhex  = style.getPropertyValue('--accent-light').trim();
    if (/^#[0-9a-fA-F]{6}$/.test(hex)) {
      accentRgb = [parseInt(hex.slice(1,3),16), parseInt(hex.slice(3,5),16), parseInt(hex.slice(5,7),16)];
    }
  }

  function resize() {
    W = canvas.width  = window.innerWidth;
    H = canvas.height = window.innerHeight;
  }

  /* ‚îÄ‚îÄ Cube definition ‚îÄ‚îÄ */
  function makeCube() {
    const s   = 18 + Math.random() * 42;   // half-size
    return {
      x:    Math.random() * W,
      y:    Math.random() * H,
      z:    0.4 + Math.random() * 0.8,     // depth scale
      s:    s,
      vx:   (Math.random() - 0.5) * 0.35,
      vy:   -0.15 - Math.random() * 0.25,  // float upward
      rx:   Math.random() * Math.PI * 2,   // rotation x
      ry:   Math.random() * Math.PI * 2,
      rz:   Math.random() * Math.PI * 2,
      drx:  (Math.random() - 0.5) * 0.008,
      dry:  (Math.random() - 0.5) * 0.010,
      drz:  (Math.random() - 0.5) * 0.006,
      alpha: 0.04 + Math.random() * 0.10,
    };
  }

  function initCubes() {
    const count = Math.min(22, Math.floor((W * H) / 48000));
    cubes = Array.from({ length: count }, makeCube);
  }

  /* ‚îÄ‚îÄ Project 3D point ‚Üí 2D ‚îÄ‚îÄ */
  function project(x, y, z, cx, cy) {
    const fov = 320;
    const d   = fov / (fov + z * 200);
    return [cx + x * d, cy + y * d, d];
  }

  /* ‚îÄ‚îÄ Rotate a point around X/Y/Z axes ‚îÄ‚îÄ */
  function rotate(px, py, pz, rx, ry, rz) {
    // X
    let y1 = py * Math.cos(rx) - pz * Math.sin(rx);
    let z1 = py * Math.sin(rx) + pz * Math.cos(rx);
    // Y
    let x2 = px * Math.cos(ry) + z1 * Math.sin(ry);
    let z2 = -px * Math.sin(ry) + z1 * Math.cos(ry);
    // Z
    let x3 = x2 * Math.cos(rz) - y1 * Math.sin(rz);
    let y3 = x2 * Math.sin(rz) + y1 * Math.cos(rz);
    return [x3, y3, z2];
  }

  /* Cube corners (unit cube centred at origin) */
  const VERTS = [
    [-1,-1,-1],[ 1,-1,-1],[ 1, 1,-1],[-1, 1,-1],
    [-1,-1, 1],[ 1,-1, 1],[ 1, 1, 1],[-1, 1, 1],
  ];
  const EDGES = [
    [0,1],[1,2],[2,3],[3,0], // back face
    [4,5],[5,6],[6,7],[7,4], // front face
    [0,4],[1,5],[2,6],[3,7], // connectors
  ];

  function drawCube(c) {
    const [r,g,b] = accentRgb;
    // Project all 8 vertices
    const pts = VERTS.map(([vx,vy,vz]) => {
      const [rx,ry,rz2] = rotate(vx*c.s, vy*c.s, vz*c.s, c.rx, c.ry, c.rz);
      return project(rx, ry, rz2, c.x, c.y);
    });

    ctx.save();
    ctx.strokeStyle = `rgba(${r},${g},${b},${c.alpha})`;
    ctx.lineWidth   = 1;
    ctx.beginPath();
    EDGES.forEach(([a,b]) => {
      ctx.moveTo(pts[a][0], pts[a][1]);
      ctx.lineTo(pts[b][0], pts[b][1]);
    });
    ctx.stroke();
    ctx.restore();
  }

  function tick() {
    ctx.clearRect(0, 0, W, H);
    readAccent();

    cubes.forEach(c => {
      // Move
      c.x  += c.vx;
      c.y  += c.vy;
      c.rx += c.drx;
      c.ry += c.dry;
      c.rz += c.drz;

      // Wrap horizontally, reset from bottom when off top
      if (c.x < -c.s * 2) c.x = W + c.s;
      if (c.x > W + c.s * 2) c.x = -c.s;
      if (c.y < -c.s * 2) {
        // respawn at bottom
        Object.assign(c, makeCube());
        c.y = H + c.s * 2;
      }

      drawCube(c);
    });

    requestAnimationFrame(tick);
  }

  resize();
  initCubes();
  tick();

  window.addEventListener('resize', () => { resize(); initCubes(); });

  /* Re-read accent when settings change (slight delay for CSS vars to update) */
  const origApply = window.__applyAccentHook;
  const observer  = new MutationObserver(() => readAccent());
  observer.observe(document.documentElement, { attributes: true, attributeFilter: ['style'] });
})();
</script>

</body>
</html>
